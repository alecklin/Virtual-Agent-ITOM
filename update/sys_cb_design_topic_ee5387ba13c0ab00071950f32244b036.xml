<?xml version="1.0" encoding="UTF-8"?><record_update sys_domain="global" table="sys_cb_design_topic">
    <sys_cb_design_topic action="INSERT_OR_UPDATE">
        <compiled_topic display_value="_PRVW__a253cb7a09c0ab006e4dae3ded44f939">ae53cb7a13c0ab00071950f32244b039</compiled_topic>
        <design_definition>{"type":"FlowTopic","triggers":[{"type":"Trigger","name":"007683c14f934559bb659c25e4bdb681","triggerType":"request","applicability":{"type":"Applicability","mode":"script","value":""},"id":"007683c14f934559bb659c25e4bdb681"}],"goals":[{"name":"primary","trigger_id":"007683c14f934559bb659c25e4bdb681","nodes":[{"type":"StartGoal","goal_id":"4c1271a7d1fc4fc1acf23895884c7b54","greeting_msg":{"type":"String","mode":"string","value":""},"id":"2da90eedd47f43b2a39963ea20edeb5b","name":"Start"},{"type":"TerminateGoal","goal_id":"4c1271a7d1fc4fc1acf23895884c7b54","confirmation_msg":{"type":"String","mode":"string","value":""},"id":"9c25abb5304a4617a59c16fb8f38238f","name":"End"},{"type":"ReferenceChoiceInputPrompt","mode":"external","id":"ce13990c499f4ff4aaf8776807aad6ba","name":"List Services","goal_id":"4c1271a7d1fc4fc1acf23895884c7b54","variable_id":"1dd8b175dde848868cec9cb123872ff5","message":{"type":"String","mode":"string","value":"Here are your services that are currently in a critical state."},"optional":false,"expression_mode":"script","script":"(function execute() {\n    var options = [];    \n\n    // query current and future planned outages \n    var gr = new GlideRecord('cmdb_ci_service_auto');\n    gr.addQuery(\"operational_status\",'1') //op status is operational\n    gr.addQuery(\"severity\", \"1\") // severity is critical\n    gr.addQuery(\"owned_by\", gs.getUserID());\n    gr.orderBy('busines_criticality');\n    gr.query();\n\n    while(gr.next()) {\n        options.push({ 'value': gr.getUniqueValue(), 'label': gr.getDisplayValue('name') });\n    }\n    \n    return options;    \n})()\n","no_options_found_message":{"type":"String","mode":"string","value":"No services in critical state"}},{"type":"OutputPrompt","value":{"type":"String","mode":"script","value":"(function execute() {\n    var fields = ['name', 'severity', 'busines_criticality', \"owned_by\", \"email\"];\n    var card = new global.VaRecordCardRenderer(true);\n\n    var msg = '';\n    var gr = new GlideRecord('cmdb_ci_service_auto');\n\n    //Go with the multiple service unless it doesn't exist\n\ngs.info(\"vaInputs.list_services is  \" + vaInputs.list_services);\ngs.info(\"varVars.singleSvc is \" + vaVars.singleSvc);\n\n    var service = vaVars.singleSvc;\n    if (!gs.nil(vaInputs.list_services))\n        service = vaInputs.list_services\n    \n    if ( gr.get(service) ) {\n        var data = card.createFields(fields, gr);\n        //var affectedValue = gr.getDisplayValue('cmdb_ci');\n        //var affectedSystem = card.createStaticField(gs.getMessage('Affected System'), affectedValue, null); //Change label text for CI to Affected System\n        //var affectedSystem = card.createStaticField(\"hello\", \"world\"); //Change label text for CI to Affected System        \n        //data.unshift(affectedSystem);\n        msg = card.renderCard(null, data);\n    }\n    return msg;\n})()\n"},"id":"cd63d12cb7a24c78a0a3ef775b8b7f25","name":"Display Service","goal_id":"4c1271a7d1fc4fc1acf23895884c7b54"},{"type":"ReferenceChoiceInputPrompt","mode":"external","id":"966c76b06c7c4677b0d8e47f045ab926","name":"Outage Options","goal_id":"4c1271a7d1fc4fc1acf23895884c7b54","variable_id":"fd56b75311f04c7fa3d5e9a848386baf","message":{"type":"String","mode":"string","value":"What would you like to do?"},"optional":false,"expression_mode":"script","script":"(function execute() {\n    var options = [];\n\n    var serviceId = vaInputs.list_services\n    if (!gs.nil(serviceId))\n        serviceId = vaVars.singleSvc;\n\ngs.info(\"serviceID is \" + serviceId);\n\n    var incident = getOpenIncident(serviceId);\n\n    if (gs.nil(incident))\n        options.push({ 'value': 'incident', 'label': 'Open Incident' });\n    else {\n        if (isRoomForEscalation(incident))\n            options.push({ 'value': 'escalation', 'label': 'Escalate Incident Priority' });\n\n        if (isMajorIncident(incident))\n            options.push({ 'value': 'major', 'label': 'Promote to Major Incident' });\n    }\n    \n    if (vaVars.count &gt; 1)\n        options.push({ 'value': 'more', 'label': 'Show more critical services' });\n        \n    options.push({ 'value': 'done', 'label': 'Done' });\n\n\n    return options;\n\n\n    function getOpenIncident(service) {  \n        var gr = new GlideRecord(\"incident\");\n        gr.addQuery(\"cmdb_ci\", service);\n        gr.addQuery(\"state\", \"!=\", ['6', '7', '8']);\n        gr.orderByDesc(\"sys_created_on\");\n        gr.setLimit(1);\n        gr.query();\n        if (gr.next())\n            return gr.sys_id + '';\n\n        return;\n    }\n\n    function isRoomForEscalation(incident) {\n        var gr = new GlideRecord(\"incident\");\n        gr.get(incident);\n        \n        if (gr.priority &gt; 1) \n            return true;\n\n        return false;\n    }    \n\n    function isMajorIncident(incident) {\n        return true;\n    }    \n})()\n","no_options_found_message":{"type":"String","mode":"string","value":"No options available currently"}},{"type":"Decision","name":"Decision","branches":[{"type":"Branch","label":"Done","expression":{"type":"Applicability","mode":"script","value":"(function execute() {\n    return vaInputs.outage_options == 'done';\n})()\n"},"id":"36afdef4f91a4ec9973768c961eceb13","name":"Done"},{"type":"Branch","label":"Major Incident","expression":{"type":"Applicability","mode":"script","value":"(function execute() {\n    return vaInputs.outage_options == 'major';\n})()\n"},"id":"0176c695256343b88d9b7b3a838e5789","name":"Major Incident"},{"type":"Branch","label":"Incident","expression":{"type":"Applicability","mode":"script","value":"(function execute() {\n    return vaInputs.outage_options == 'incident';\n})()\n"},"id":"910bec2855d448bc9f61bdc0690dcaa6","name":"Incident"},{"type":"Branch","label":"Escalation","expression":{"type":"Applicability","mode":"script","value":"(function execute() {\n    return vaInputs.outage_options == 'escalation';\n})()\n"},"id":"85abb8fefbc449a98b98f4693f73e8bb","name":"Escalation"},{"type":"Branch","label":"More","expression":{"type":"Applicability","mode":"script","value":"(function execute() {\n    return vaInputs.outage_options == 'more';\n})()\n"},"id":"45320f6c82c84620bb82194c4fe9ab5e","name":"More"}],"id":"2be710c275fe476fb56ba644ffd7a3d1","goal_id":"4c1271a7d1fc4fc1acf23895884c7b54"},{"type":"OutputPrompt","value":{"type":"String","mode":"script","value":"(function execute() {\n    var appSrv = new GlideRecord('cmdb_ci_service_auto');\n    appSrv.get(vaInputs.list_services);\n\n\n    var gr = new GlideRecord(\"incident\");\n    gr.short_description = \"The service is in a critical state.\"\n    gr.cmdb_ci = vaInputs.list_services;\n    var sys_id = gr.insert();\n\n    return gr.number + \" has been created for \" + appSrv.name;\n\n\n})()\n"},"id":"14818b1374c44e28bcdabb6aaba69fd2","name":"Open Incident","goal_id":"4c1271a7d1fc4fc1acf23895884c7b54"},{"type":"OutputPrompt","value":{"type":"String","mode":"script","value":"(function execute() {\n\n    var incident = getOpenIncident(vaInputs.list_services);\n\n    var gr = new GlideRecord(\"incident\");\n    gr.get(incident);\n\n    gr.impact = 1;\n    gr.urgency = 1;\n    commentOnTask(gr, gs.getUserName() + \" has escalated the priority of the incident\");\n    gr.update();\n\n\n    return 'Escalated the ' + gr.number + ' priority to ' + gr.priority.getDisplayValue();\n\n    function getOpenIncident(service) {\n        var gr = new GlideRecord(\"incident\");\n        gr.addQuery(\"cmdb_ci\", service);\n        gr.addQuery(\"state\", \"!=\", ['6', '7', '8']);\n        gr.orderByDesc(\"sys_created_on\");\n        gr.setLimit(1);\n        gr.query();\n        if (gr.next())\n            return gr.sys_id + '';\n\n        return;\n    }\n\n\n    function commentOnTask(taskGr, msg) {\n        var comment = msg;\n\n        var existingComments = taskGr.comments.getJournalEntry(-1).split('\\n\\n');\n        for (var i = 0; i &lt; existingComments.length; i++) {\n\t\t\tvar existingComment = existingComments[i];\n\n\t\t\texistingCommentMod = existingComment.replace(/\\n/g, '');\n\t\t\tcommentMod = comment.replace(/\\n/g,'');\n\t\t\t\n            if (existingCommentMod.indexOf(commentMod) &gt;= 0) {\n                return;\n            }\n        }\n\n        taskGr.comments = comment;\n    }\n\n})()\n"},"id":"44075498d44e47dc832d118d61b41e02","name":"Escalate priority","goal_id":"4c1271a7d1fc4fc1acf23895884c7b54"},{"type":"OutputPrompt","value":{"type":"String","mode":"string","value":"Here's the detail for the service"},"id":"2554b43e241a443b8e013c31b6024273","name":"Service detail","goal_id":"4c1271a7d1fc4fc1acf23895884c7b54"},{"type":"ScriptedAction","script":"(function execute() {\n    // reset to first page\n    vaVars.index = 0;\n\n    function getNumberOfCriticalServices() {\n        // count how many outages there are\n        var count = 0;\n        var gr = new GlideAggregate('cmdb_ci_service_auto');\n        gr.addQuery(\"operational_status\",'1') //op status is operational\n        gr.addQuery(\"severity\", \"1\") // severity is critical\n        gr.addQuery(\"owned_by\", gs.getUserID());\n        gr.addAggregate('COUNT');\n        gr.query();\n        if (gr.next())\n            count = gr.getAggregate('COUNT');\n\n        return count;\n    }    \n\n    // set count variable\n    vaVars.count = getNumberOfCriticalServices();\n})()\n","id":"8d41569e33294235b06a8f4f587db562","name":"Check critical status","goal_id":"4c1271a7d1fc4fc1acf23895884c7b54"},{"type":"Decision","name":"Decision","branches":[{"type":"Branch","label":"Multiple","expression":{"type":"Applicability","mode":"script","value":"(function execute() {\n    return vaVars.count &gt; 1;\n})()\n"},"id":"a9cc3b64afd34b779ed99e15de1ccd9d","name":"Multiple"},{"type":"Branch","label":"No outage","expression":{"type":"Applicability","mode":"script","value":"(function execute() {\n    return vaVars.count == 0;\n})()\n"},"id":"62f584a906ec4171bc2995197f9f7d8a","name":"No outage"},{"type":"Branch","label":"One outage","expression":{"type":"Applicability","mode":"script","value":"(function execute() {\n    return vaVars.count == 1;\n})()\n"},"id":"adcaa38fe5454ccb91bfde029750d98d","name":"One outage"}],"id":"7ca5fb1669de4845a06e3d9c8e53fbe0","goal_id":"4c1271a7d1fc4fc1acf23895884c7b54"},{"type":"OutputPrompt","value":{"type":"String","mode":"string","value":"Great news, there are no known application service outages!"},"id":"30a1cf633d114ce0a4ad7d2f7a5a7b91","name":"No Application Service outage","goal_id":"4c1271a7d1fc4fc1acf23895884c7b54"},{"type":"OutputPrompt","value":{"type":"String","mode":"script","value":"(function execute() {\n    // query current and future planned outages \n    var gr = new GlideRecord('cmdb_ci_service_auto');\n    gr.addQuery(\"operational_status\",'1') //op status is operational\n    gr.addQuery(\"severity\", \"1\") // severity is critical\n    gr.addQuery(\"owned_by\", gs.getUserID());\n    gr.orderBy('busines_criticality');\n    gr.query();\n\n    if (gr.next()) {\n        vaVars.singleSvc = gr.sys_id + ''\n    }\n    \n    var msg = \"You have exactly one application service in critical state.\";\n\n    return msg;\n})()\n"},"id":"37cf05749c8a4ecc96b2b91d49329958","name":"Single outage","goal_id":"4c1271a7d1fc4fc1acf23895884c7b54"}],"edges":[{"type":"Edge","source_node_id":"37cf05749c8a4ecc96b2b91d49329958","target_node_id":"2554b43e241a443b8e013c31b6024273","id":"b577ca1e6d59445b9d4efeb6fecda16a"},{"type":"Edge","source_node_id":"ce13990c499f4ff4aaf8776807aad6ba","target_node_id":"2554b43e241a443b8e013c31b6024273","id":"c30bad271cb64ea5b4c6cc9e4c4257a7"},{"type":"Edge","source_node_id":"cd63d12cb7a24c78a0a3ef775b8b7f25","target_node_id":"966c76b06c7c4677b0d8e47f045ab926","id":"ecca09d9139b4648808f074a5010bb2e"},{"type":"Edge","source_node_id":"966c76b06c7c4677b0d8e47f045ab926","target_node_id":"2be710c275fe476fb56ba644ffd7a3d1","id":"6012f6c756a94c959f6704fc3c8c6de1"},{"type":"Edge","source_node_id":"2be710c275fe476fb56ba644ffd7a3d1","target_node_id":"9c25abb5304a4617a59c16fb8f38238f","branch_id":"36afdef4f91a4ec9973768c961eceb13","id":"5c8326f1c56448da9095ec2aa1cbc2d7","name":"36afdef4f91a4ec9973768c961eceb13"},{"type":"Edge","source_node_id":"2be710c275fe476fb56ba644ffd7a3d1","target_node_id":"966c76b06c7c4677b0d8e47f045ab926","branch_id":"0176c695256343b88d9b7b3a838e5789","id":"2d84530dc4e64558a275f422e9d02476","name":"0176c695256343b88d9b7b3a838e5789"},{"type":"Edge","source_node_id":"2be710c275fe476fb56ba644ffd7a3d1","target_node_id":"14818b1374c44e28bcdabb6aaba69fd2","branch_id":"910bec2855d448bc9f61bdc0690dcaa6","id":"518f5c53e66f49eab89660c4b3719516","name":"910bec2855d448bc9f61bdc0690dcaa6"},{"type":"Edge","source_node_id":"14818b1374c44e28bcdabb6aaba69fd2","target_node_id":"966c76b06c7c4677b0d8e47f045ab926","id":"ff594748ff4c4ab4997fa13886cdca50"},{"type":"Edge","source_node_id":"2be710c275fe476fb56ba644ffd7a3d1","target_node_id":"44075498d44e47dc832d118d61b41e02","branch_id":"85abb8fefbc449a98b98f4693f73e8bb","id":"9f1fd48535de4f0ebe7ecdc8a471d4a2","name":"85abb8fefbc449a98b98f4693f73e8bb"},{"type":"Edge","source_node_id":"44075498d44e47dc832d118d61b41e02","target_node_id":"966c76b06c7c4677b0d8e47f045ab926","id":"ebf58478f06347a9b184cba6695d909b"},{"type":"Edge","source_node_id":"2554b43e241a443b8e013c31b6024273","target_node_id":"cd63d12cb7a24c78a0a3ef775b8b7f25","id":"f6742b3a044f48fbbaef5cc15c1cb8eb"},{"type":"Edge","source_node_id":"2be710c275fe476fb56ba644ffd7a3d1","target_node_id":"ce13990c499f4ff4aaf8776807aad6ba","branch_id":"45320f6c82c84620bb82194c4fe9ab5e","id":"941d7237bb394a4aa64e6c31da4701da","name":"45320f6c82c84620bb82194c4fe9ab5e"},{"type":"Edge","source_node_id":"2da90eedd47f43b2a39963ea20edeb5b","target_node_id":"8d41569e33294235b06a8f4f587db562","id":"4f04ef2f401c45e5886e39f7585349d0"},{"type":"Edge","source_node_id":"8d41569e33294235b06a8f4f587db562","target_node_id":"7ca5fb1669de4845a06e3d9c8e53fbe0","id":"56933f19a5d1492a98c7831e23792fa0"},{"type":"Edge","source_node_id":"7ca5fb1669de4845a06e3d9c8e53fbe0","target_node_id":"ce13990c499f4ff4aaf8776807aad6ba","branch_id":"a9cc3b64afd34b779ed99e15de1ccd9d","id":"d6aee492c20f4a3c898204b64d6b36a9","name":"a9cc3b64afd34b779ed99e15de1ccd9d"},{"type":"Edge","source_node_id":"7ca5fb1669de4845a06e3d9c8e53fbe0","target_node_id":"30a1cf633d114ce0a4ad7d2f7a5a7b91","branch_id":"62f584a906ec4171bc2995197f9f7d8a","id":"3ff33e0d4f0740989fb5f2a15333cd08","name":"62f584a906ec4171bc2995197f9f7d8a"},{"type":"Edge","source_node_id":"30a1cf633d114ce0a4ad7d2f7a5a7b91","target_node_id":"9c25abb5304a4617a59c16fb8f38238f","id":"a333e47b11c34dfebefdbea75b882dd8"},{"type":"Edge","source_node_id":"7ca5fb1669de4845a06e3d9c8e53fbe0","target_node_id":"37cf05749c8a4ecc96b2b91d49329958","branch_id":"adcaa38fe5454ccb91bfde029750d98d","id":"7e38b8c611ad4741a6456cd1da4f4431","name":"adcaa38fe5454ccb91bfde029750d98d"}],"id":"4c1271a7d1fc4fc1acf23895884c7b54"}],"script_variables":[{"type":"String","name":"count","value":{"type":"String","mode":"string","value":""},"id":"014b5487d0224e6d99aec96aae1c31ca"},{"type":"String","name":"singleSvc","value":{"type":"String","mode":"string","value":"Represents the single service that is in critical state"},"id":"d8e0ec748f554fcdb2938a9ee98bf065"}],"glide_variables":[{"type":"Choice","choices":[],"id":"1dd8b175dde848868cec9cb123872ff5","name":"list_services","table":""},{"type":"Choice","choices":[],"id":"fd56b75311f04c7fa3d5e9a848386baf","name":"outage_options","table":""}],"applicability":{"type":"Applicability","mode":"script","value":""},"roles":[],"scope":"122ec67913fb1b0058efb1422244b09f","id":"094f02f913fb1b0058efb1422244b05f","name":"_PRVW__a253cb7a09c0ab006e4dae3ded44f939","key_phrases":["Application Service Status","Service Status","outage","down","working","system status"]}</design_definition>
        <design_topic_id>094f02f913fb1b0058efb1422244b05f</design_topic_id>
        <name>_PRVW__a253cb7a09c0ab006e4dae3ded44f939</name>
        <sys_class_name>sys_cb_design_topic</sys_class_name>
        <sys_created_by>aleck.lin</sys_created_by>
        <sys_created_on>2018-08-24 21:52:56</sys_created_on>
        <sys_domain>global</sys_domain>
        <sys_id>ee5387ba13c0ab00071950f32244b036</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>FlowTopic</sys_name>
        <sys_package display_value="Virtual Agent ITOM" source="x_snc_va_itom">122ec67913fb1b0058efb1422244b09f</sys_package>
        <sys_policy/>
        <sys_scope display_value="Virtual Agent ITOM">122ec67913fb1b0058efb1422244b09f</sys_scope>
        <sys_update_name>sys_cb_design_topic_ee5387ba13c0ab00071950f32244b036</sys_update_name>
        <sys_updated_by>aleck.lin</sys_updated_by>
        <sys_updated_on>2018-08-24 21:52:56</sys_updated_on>
        <type>FlowTopic</type>
    </sys_cb_design_topic>
</record_update>
